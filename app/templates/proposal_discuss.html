{% extends "base.html" %}

{% block content %}
  <div class="card mb-3">
    <div class="card-body d-flex">
      {% if proposal.recipe.image %}
        <img src="{{ url_for('static', filename='uploads/'~proposal.recipe.image) }}" style="width:96px;height:96px;object-fit:cover;margin-right:12px;">
      {% else %}
        <img src="{{ url_for('static', filename='img/default-avatar.svg') }}" style="width:96px;height:96px;object-fit:cover;margin-right:12px;">
      {% endif %}
      <div>
        <h5 class="mb-1"><a href="{{ url_for('main.recipe_detail', recipe_id=proposal.recipe.id) }}">{{ proposal.recipe.title }}</a></h5>
        <div class="small text-muted">By {{ proposal.proposer.username }} Â· {{ proposal.date.strftime('%Y-%m-%d') }}</div>
        <p class="mt-2 small">{{ proposal.recipe.ingredients|truncate(120) }}</p>
      </div>
      <div class="ms-auto text-end">
        <div class="badge bg-primary p-2" style="font-size:0.95rem;">
          Starts: {{ proposal.start_time.strftime('%H:%M') if proposal.start_time else '12:00' }}
        </div>
      </div>
    </div>
  </div>

  <div class="mb-3">
    {% if proposal.grocery_user %}
      <div class="alert alert-info">
        <strong>{{ proposal.grocery_user.username }}</strong> will do the grocery shopping.
      </div>
    {% endif %}

    {% if current_user.is_authenticated %}
      <form method="post" action="{{ url_for('main.claim_grocery', proposal_id=proposal.id) }}">
        {% if proposal.grocery_user_id == current_user.id %}
          <button class="btn btn-danger">I changed my mind (unclaim)</button>
        {% elif not proposal.grocery_user %}
          <button class="btn btn-success">I'll do the groceries</button>
        {% else %}
          <button class="btn btn-secondary" disabled>Someone else will do the groceries</button>
        {% endif %}
      </form>
    {% endif %}
  </div>

  <div class="mb-3">
    <h6>Participants</h6>
    <div class="d-flex gap-2 align-items-center">
      {% if proposal.participants|length == 0 %}
        <div class="text-muted">No participants yet</div>
      {% endif %}
      {% for pa in proposal.participants %}
        <div class="d-flex align-items-center">
          {% if pa.user.avatar %}
            <img src="{{ url_for('static', filename='uploads/'~pa.user.avatar) }}" style="width:40px;height:40px;object-fit:cover;border-radius:6px;margin-right:8px;">
          {% else %}
            <img src="{{ url_for('static', filename='img/default-avatar.svg') }}" style="width:40px;height:40px;object-fit:cover;border-radius:6px;margin-right:8px;">
          {% endif %}
          <div>{{ pa.user.username }}</div>
        </div>
      {% endfor %}
    </div>
  </div>

  <h2>Discussion for: {{ proposal.recipe.title }} on {{ proposal.date.strftime('%Y-%m-%d') }}</h2>

  <div class="mb-3">
    {% for m in messages %}
      <div class="border rounded p-2 mb-2 d-flex">
        <div class="me-3">
          {% if m.user.avatar %}
            <img src="{{ url_for('static', filename='uploads/'~m.user.avatar) }}" style="width:48px;height:48px;object-fit:cover;border-radius:6px;">
          {% else %}
            <img src="{{ url_for('static', filename='img/default-avatar.svg') }}" style="width:48px;height:48px;object-fit:cover;border-radius:6px;">
          {% endif %}
        </div>
        <div class="flex-grow-1">
          <div class="small text-muted">{{ m.user.username }} - {{ m.created_at.strftime('%Y-%m-%d %H:%M') }}</div>
          <div>{{ m.content }}</div>
        </div>
      </div>
    {% endfor %}
   </div>

  <form method="post">
    <div class="mb-3">
      <textarea name="content" class="form-control" rows="4" required></textarea>
    </div>
    <button class="btn btn-primary">Post</button>
  </form>
{% endblock %}
