{% extends "base.html" %}

{% block content %}
  <div class="d-flex align-items-center mb-3">
    <div>
      <h2 class="mb-0">Recipes</h2>
      <p class="mb-0">Browse recipes.</p>
    </div>
    <div class="ms-auto">
      <a class="btn btn-primary" href="{{ url_for('main.add_recipe') }}">New recipe</a>
    </div>
  </div>

  <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
    {% for r in recipes %}
      <div class="col">
        <div class="card h-100">
          {% if r.image %}
            <img src="{{ url_for('static', filename='uploads/'~r.image) }}" class="card-img-top" style="height:180px;object-fit:cover;" alt="{{ r.title }}">
          {% endif %}
          <div class="card-body d-flex flex-column">
            <h5 class="card-title">{{ r.title }}</h5>
            <p class="card-text small text-muted mb-2">By {{ r.author.username if r.author else 'unknown' }}</p>
            <p class="card-text">{{ r.ingredients|truncate(150) }}</p>
            <div class="mt-auto">
              <a href="{{ url_for('main.recipe_detail', recipe_id=r.id) }}" class="btn btn-sm btn-outline-primary">Open</a>
              <button class="btn btn-sm btn-outline-success" onclick="quickPropose('{{ r.id }}')">Quick propose</button>
            </div>
          </div>
          <div class="card-footer">
            <form method="post" action="{{ url_for('main.propose_recipe_form') }}" class="d-flex gap-2">
              <input type="date" name="date" class="form-control form-control-sm" required>
              <input type="hidden" name="recipe_id" value="{{ r.id }}">
              <button class="btn btn-sm btn-primary">Propose</button>
            </form>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>

  <script>
  const proposeUrl = "{{ url_for('main.propose_recipe_js') }}";
  const calendarUrl = "{{ url_for('main.calendar_view') }}";
  function quickPropose(recipe_id){
    const date = prompt('Date (YYYY-MM-DD)');
    if(!date) return;
    fetch(proposeUrl, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({recipe_id: recipe_id, date: date})
    })
    .then(r=>r.json())
    .then(j=>{
      if(j && j.status==='ok') {
        window.location.href = calendarUrl;
      } else {
        alert(j && j.message ? j.message : 'error');
      }
    })
    .catch(()=> alert('Network error'));
  }
  </script>
{% endblock %}
